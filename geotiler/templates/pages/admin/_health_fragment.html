{# Health fragment for HTMX auto-refresh #}

{# Status Banner #}
<div class="status-banner">
    <div class="status-banner-header">
        <div class="status-banner-title">
            System Status:
            <span class="badge badge-{{ health.status }}">
                {{ health.status }}
            </span>
        </div>
        <label class="auto-refresh-label">
            <input type="checkbox" id="auto-refresh" checked onchange="toggleAutoRefresh()">
            Auto-refresh (30s)
            <span class="htmx-indicator spinner"></span>
        </label>
    </div>
    <div class="stats-row">
        <div class="stat-item">
            <div class="stat-value">{{ version }}</div>
            <div class="stat-label">Version</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ "%.0f"|format(health.hardware.ram_utilization_percent|default(0)) }}%</div>
            <div class="stat-label">Memory</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ "%.0f"|format(health.hardware.cpu_utilization_percent|default(0)) }}%</div>
            <div class="stat-label">CPU</div>
        </div>
    </div>
</div>

{# Runtime Environment Resources #}
{% set hw = health.hardware %}
{% set ram_pct = hw.ram_utilization_percent|default(0) %}
{% set cpu_pct = hw.cpu_utilization_percent|default(0) %}
{% set ram_level = 'level-critical' if ram_pct >= 90 else ('level-warning' if ram_pct >= 75 else 'level-ok') %}
{% set cpu_level = 'level-critical' if cpu_pct >= 90 else ('level-warning' if cpu_pct >= 70 else 'level-ok') %}
<div class="resources-section">
    <h3>Runtime Environment</h3>
    <div class="resource-grid">
        {# Azure Site #}
        <div class="resource-card">
            <div class="resource-icon">‚òÅÔ∏è</div>
            <div class="resource-details">
                <div class="resource-label">Azure Site</div>
                <div class="resource-value">{{ hw.azure_site_name|default('local') }}</div>
                <div class="resource-sub">
                    {{ hw.azure_sku|default('Dev') }}
                    {% if hw.azure_instance_id %} ¬∑ {{ hw.azure_instance_id }}{% endif %}
                </div>
            </div>
        </div>

        {# CPU #}
        <div class="resource-card">
            <div class="resource-icon">‚ö°</div>
            <div class="resource-details">
                <div class="resource-label">CPU</div>
                <div class="resource-value">{{ hw.cpu_count|default('?') }} cores</div>
                <div class="utilization-bar">
                    <div class="utilization-fill {{ cpu_level }}" style="width: {{ [cpu_pct, 100]|min }}%;"></div>
                </div>
                <div class="resource-sub">{{ "%.1f"|format(cpu_pct) }}% utilized</div>
            </div>
        </div>

        {# Memory #}
        <div class="resource-card">
            <div class="resource-icon">üíæ</div>
            <div class="resource-details">
                <div class="resource-label">Memory</div>
                <div class="resource-value">{{ hw.total_ram_gb|default('?') }} GB total</div>
                <div class="utilization-bar">
                    <div class="utilization-fill {{ ram_level }}" style="width: {{ [ram_pct, 100]|min }}%;"></div>
                </div>
                <div class="resource-sub">
                    {% if hw.available_ram_mb %}
                        {{ "%.1f"|format(hw.available_ram_mb / 1024) }} GB available
                    {% else %}
                        {{ "%.1f"|format(100 - ram_pct) }}% free
                    {% endif %}
                </div>
            </div>
        </div>

        {# Process Memory #}
        <div class="resource-card">
            <div class="resource-icon">üìä</div>
            <div class="resource-details">
                <div class="resource-label">Process Memory</div>
                <div class="resource-value">
                    {% if hw.process_rss_mb %}
                        {% if hw.process_rss_mb >= 1024 %}
                            {{ "%.2f"|format(hw.process_rss_mb / 1024) }} GB
                        {% else %}
                            {{ "%.0f"|format(hw.process_rss_mb) }} MB
                        {% endif %}
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="resource-sub">RSS (resident set size)</div>
            </div>
        </div>

        {# Platform #}
        <div class="resource-card">
            <div class="resource-icon">üñ•Ô∏è</div>
            <div class="resource-details">
                <div class="resource-label">Platform</div>
                <div class="resource-value">{{ hw.platform|default('unknown') }}</div>
                <div class="resource-sub">Python {{ hw.python_version|default('?') }}</div>
            </div>
        </div>

        {# Region #}
        {% if hw.azure_region and hw.azure_region != 'unknown' %}
        <div class="resource-card">
            <div class="resource-icon">üåç</div>
            <div class="resource-details">
                <div class="resource-label">Region</div>
                <div class="resource-value">{{ hw.azure_region }}</div>
                <div class="resource-sub">Azure deployment region</div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{# Issues Section #}
{% if health.issues %}
<div class="issues-section">
    <div class="issues-header">Issues Detected</div>
    <ul class="issues-list">
        {% for issue in health.issues %}
        <li>{{ issue }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{# Services Grid #}
<div class="section-header">Services</div>
<div class="cards-grid">
    {% for name, data in health.services.items() %}
    {% set landing_pages = {'cog': '/cog/', 'xarray': '/xarray/', 'pgstac': '/searches/', 'tipg': '/vector', 'stac_api': '/stac/'} %}
    {% set link = landing_pages.get(name) %}

    {% if link and data.available %}
    <a href="{{ link }}" class="card card-link">
    {% else %}
    <div class="card">
    {% endif %}
        <div class="card-header">
            <span class="card-title">{{ name.upper().replace('_', ' ') }}</span>
            <span class="badge badge-{{ data.status }}">{{ data.status }}</span>
        </div>
        <div class="card-description">{{ data.description }}</div>
        {% if data.endpoints %}
        <div class="card-endpoints"><code>{{ data.endpoints[0] }}</code></div>
        {% elif data.disabled_reason %}
        <div class="card-endpoints" style="color: var(--ds-gray);">{{ data.disabled_reason }}</div>
        {% endif %}
    {% if link and data.available %}
    </a>
    {% else %}
    </div>
    {% endif %}
    {% endfor %}
</div>

{# Dependencies Grid #}
<div class="section-header">Dependencies</div>
<div class="cards-grid">
    {% for name, data in health.dependencies.items() %}
    {% set status_class = 'dep-ok' if data.status == 'ok' else ('dep-warning' if data.status == 'warning' else 'dep-fail') %}
    {% set pretty_names = {'database': 'Database', 'storage_oauth': 'Storage OAuth', 'postgres_oauth': 'PostgreSQL OAuth'} %}

    <div class="dep-card {{ status_class }}">
        <div class="dep-header">
            <span class="dep-name">{{ pretty_names.get(name, name) }}</span>
            <span class="badge badge-{{ data.status }}">{{ data.status }}</span>
        </div>
        <div class="dep-detail">
            {% if name == 'database' and data.ping_time_ms %}
                {{ "%.0f"|format(data.ping_time_ms) }}ms ping
            {% elif data.expires_in_seconds %}
                {% if data.expires_in_seconds > 3600 %}
                    {{ (data.expires_in_seconds // 3600)|int }}h {{ ((data.expires_in_seconds % 3600) // 60)|int }}m TTL
                {% elif data.expires_in_seconds > 60 %}
                    {{ (data.expires_in_seconds // 60)|int }}m TTL
                {% else %}
                    {{ data.expires_in_seconds }}s TTL
                {% endif %}
            {% elif data.note %}
                {{ data.note }}
            {% elif data.error %}
                {{ data.error[:40] }}{% if data.error|length > 40 %}...{% endif %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

{# Configuration Section #}
<div class="section-header">Configuration</div>
<div class="config-grid">
    {% set config = health.config %}
    <div class="config-item">
        <span class="config-label">Storage Auth:</span>
        <span class="config-value {{ 'config-on' if config.enable_storage_auth else 'config-off' }}">
            {{ 'ON' if config.enable_storage_auth else 'OFF' }}
        </span>
    </div>
    <div class="config-item">
        <span class="config-label">CLI Auth:</span>
        <span class="config-value {{ 'config-on' if config.auth_use_cli else 'config-off' }}">
            {{ 'ON' if config.auth_use_cli else 'OFF' }}
        </span>
    </div>
    <div class="config-item">
        <span class="config-label">TiPG:</span>
        <span class="config-value {{ 'config-on' if config.tipg_enabled else 'config-off' }}">
            {{ 'ON' if config.tipg_enabled else 'OFF' }}
        </span>
    </div>
    <div class="config-item">
        <span class="config-label">STAC API:</span>
        <span class="config-value {{ 'config-on' if config.stac_api_enabled else 'config-off' }}">
            {{ 'ON' if config.stac_api_enabled else 'OFF' }}
        </span>
    </div>
</div>
