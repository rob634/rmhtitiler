version: '3.8'

services:
  # ============================================================================
  # PostgreSQL with pgSTAC extension
  # ============================================================================
  database:
    image: ghcr.io/stac-utils/pgstac:v0.8.5
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgis
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: postgis
    ports:
      - "5439:5432"
    volumes:
      - pgstac_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgis"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================================================
  # TiTiler-pgSTAC with Xarray support
  # ============================================================================
  titiler:
    build:
      context: .
      dockerfile: Dockerfile.local
    ports:
      - "8001:8000"
    depends_on:
      database:
        condition: service_healthy

    environment:
      # PostgreSQL connection (uses password mode for local dev)
      GEOTILER_PG_HOST: database
      GEOTILER_PG_PORT: 5432
      GEOTILER_PG_DB: postgis
      GEOTILER_PG_USER: postgres
      GEOTILER_PG_PASSWORD: postgres
      GEOTILER_PG_AUTH_MODE: password

      # Azure Storage authentication (uses Azure CLI credentials)
      GEOTILER_ENABLE_STORAGE_AUTH: "true"
      GEOTILER_AUTH_USE_CLI: "true"
      GEOTILER_STORAGE_ACCOUNT: ${AZURE_STORAGE_ACCOUNT:-rmhgeopipelines}

      # Observability - enable request timing logs
      GEOTILER_ENABLE_OBSERVABILITY: "true"
      GEOTILER_OBS_SLOW_THRESHOLD_MS: "2000"
      GEOTILER_OBS_SERVICE_NAME: "geotiler-local"
      GEOTILER_OBS_ENVIRONMENT: "dev"

    volumes:
      # Mount local data directory for testing
      - ./data:/data:ro

      # Mount Azure CLI credentials for local development
      # This allows DefaultAzureCredential to use your 'az login' credentials
      - ~/.azure:/root/.azure:ro

      # Mount source code for hot reload during development
      - ./geotiler:/app/geotiler:ro
      - ./dashboard:/app/dashboard:ro

    command: >
      uvicorn geotiler.main:app
      --host 0.0.0.0
      --port 8000
      --reload
      --reload-dir /app/geotiler
      --log-level info

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/livez"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# Persistent volume for PostgreSQL data
volumes:
  pgstac_data:
